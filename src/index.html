<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Made by Ray</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&family=Orbitron:wght@400..900&display=swap"
    rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- Aero Glass Aesthetics --- */
    body {
      font-family: 'Quicksand', 'Segoe UI', Tahoma, sans-serif;
      overflow: hidden;
      /* Prevent body scroll, handle inside panel */
    }

    /* The Glass Panel */
    .aero-glass {
      background: linear-gradient(135deg,
          rgba(255, 255, 255, 0.1) 0%,
          rgba(255, 255, 255, 0.03) 100%);
      backdrop-filter: blur(25px) saturate(160%);
      -webkit-backdrop-filter: blur(25px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-top: 1px solid rgba(255, 255, 255, 0.3);
      border-left: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow:
        0 30px 60px -12px rgba(0, 0, 0, 0.45),
        inset 0 1px 0 rgba(255, 255, 255, 0.15);
      color: #ffffff;
      position: relative;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: default;
    }

    .aero-glass:hover {
      border-color: rgba(255, 255, 255, 0.3);
      box-shadow:
        0 40px 80px -15px rgba(0, 0, 0, 0.6),
        inset 0 1px 0 rgba(255, 255, 255, 0.25);
    }

    /* Glass Shine Effect */
    .aero-glass::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 50%;
      background: linear-gradient(to bottom,
          rgba(255, 255, 255, 0.1) 0%,
          transparent 100%);
      pointer-events: none;
      z-index: -1;
    }

    /* Input Field Glass */
    .glass-input {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      color: #fff;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    .glass-input:focus {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.4);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1), inset 0 2px 4px rgba(0, 0, 0, 0.2);
      outline: none;
    }

    /* Glossy Button */
    .aero-btn {
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(0, 0, 0, 0.1) 51%, rgba(0, 0, 0, 0.2) 100%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, 0.3),
        0 4px 8px rgba(0, 0, 0, 0.4);
      transition: all 0.2s;
    }

    .aero-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    .aero-btn:active {
      transform: translateY(1px);
    }

    /* Chat Bubbles */
    .bubble-user {
      background: linear-gradient(135deg, #169778 0%, #0e634e 100%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(8px);
      color: white;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
      box-shadow: 0 8px 25px rgba(22, 151, 120, 0.3);
      position: relative;
      overflow: hidden;
    }

    .bubble-user::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent 45%, rgba(255, 255, 255, 0.1) 50%, transparent 55%);
      animation: shine 3s infinite;
    }

    .bubble-bot {
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.2) 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      color: white;
      box-shadow:
        0 8px 32px 0 rgba(0, 0, 0, 0.3),
        inset 0 0 10px rgba(255, 255, 255, 0.05);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    @keyframes shine {
      0% {
        transform: translateX(-100%) translateY(-100%) rotate(45deg);
      }

      100% {
        transform: translateX(100%) translateY(100%) rotate(45deg);
      }
    }

    .pop-in {
      animation: popIn 0.5s cubic-bezier(0.26, 0.53, 0.74, 1.48) both;
    }

    @keyframes popIn {
      0% {
        opacity: 0;
        transform: scale(0.9) translateY(20px);
      }

      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }


    /* --- Layout & Responsive --- */
    #main-layout {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 2rem;
      box-sizing: border-box;
      z-index: 10;
      overflow: hidden;
      /* Prevent scrollbars from scaling */
    }

    /* --- Left Side Widgets Area --- */
    .widgets-main-container {
      /* Removed absolute positioning */
      display: grid;
      grid-template-columns: 240px 320px;
      grid-template-rows: auto 1fr auto;
      gap: 1.5rem 3rem;
      z-index: 10;
      pointer-events: none;

      /* Scaling Logic */
      transform-origin: top left;
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      margin-top: 3rem;
      /* Visual offset to match original */
      margin-left: 3rem;
    }

    /* Responsive Scaling */
    @media (max-width: 1600px) {
      .widgets-main-container {
        transform: scale(0.9);
        margin-left: 1rem;
      }
    }

    @media (max-width: 1366px) {
      .widgets-main-container {
        transform: scale(0.8);
        margin-left: 0;
      }

      #main-layout {
        padding: 1.5rem;
      }
    }

    @media (max-width: 1100px) {
      .widgets-main-container {
        transform: scale(0.7);
        gap: 1rem 2rem;
      }
    }

    @media (max-width: 900px) {
      .widgets-main-container {
        transform: scale(0.6);
      }
    }


    .column-1,
    .column-2 {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      align-items: center;
    }

    .footer-area {
      grid-column: span 2;
      display: flex;
      justify-content: left;
      padding-top: 4rem;
    }

    /* Analog Clock */
    .analog-clock {
      width: 220px;
      height: 220px;
      border-radius: 50%;
      position: relative;
      background: conic-gradient(from 0deg, red, orange, yellow, green, cyan, blue, violet, red);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(255, 255, 255, 0.2);
      border: 2px solid rgba(255, 255, 255, 0.2);
      pointer-events: auto;
    }

    .analog-clock::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 50%;
      backdrop-filter: blur(4px);
      z-index: 1;
    }

    .clock-number {
      position: absolute;
      width: 30px;
      height: 30px;
      text-align: center;
      line-height: 30px;
      font-size: 1.1rem;
      font-weight: 800;
      color: white;
      z-index: 3;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
    }

    .clock-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      box-shadow: 0 0 8px white;
    }

    .hand {
      position: absolute;
      bottom: 50%;
      left: 50%;
      transform-origin: bottom;
      border-radius: 10px;
      z-index: 5;
    }

    .hour-hand {
      width: 5px;
      height: 60px;
      background: white;
    }

    .min-hand {
      width: 4px;
      height: 85px;
      background: rgba(255, 255, 255, 0.8);
    }

    .sec-hand {
      width: 2px;
      height: 95px;
      background: #ff4444;
      transition: transform 0.05s cubic-bezier(0.1, 2.7, 0.58, 1);
    }

    /* Digital Clock */
    .digital-clock {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.2rem;
      color: white;
      text-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
      letter-spacing: 2px;
      pointer-events: auto;
    }

    /* Note Space */
    .note-space {
      width: 100%;
      height: 180px;
      background: rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 1rem;
      color: white;
      font-size: 1.1rem;
      resize: none;
      pointer-events: auto;
      transition: all 0.3s;
      font-family: 'Quicksand', sans-serif;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .note-space:focus {
      background: rgba(0, 0, 0, 0.25);
      border-color: rgba(255, 255, 255, 0.3);
      outline: none;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    }

    /* Big Date Display */
    .big-date-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: white;
      line-height: 1;
    }

    .date-month {
      font-size: 1.3rem;
      opacity: 0.8;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .date-number {
      font-size: 7rem;
      font-weight: 800;
      margin: 0.4rem 0;
      text-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
    }

    .date-day {
      font-size: 1.3rem;
      opacity: 0.8;
      letter-spacing: 1px;
    }

    /* Calendar */
    .calendar-widget {
      width: 100%;
      font-size: 0.9rem;
      color: white;
      background: rgba(0, 0, 0, 0.15);
      padding: 1.5rem;
      border-radius: 20px;
      backdrop-filter: blur(12px);
      pointer-events: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      text-align: center;
    }

    .calendar-day-header {
      font-weight: bold;
      opacity: 0.7;
      margin-bottom: 10px;
      font-size: 1rem;
    }

    .calendar-day {
      padding: 6px;
    }

    .calendar-day.today {
      background: white;
      color: black;
      border-radius: 50%;
      font-weight: bold;
      box-shadow: 0 0 15px white;
    }

    /* Glowing Quote */
    .glowing-quote {
      text-align: left;
      color: white;
      font-size: 1.2rem;
      font-style: italic;
      line-height: 1.6;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
      animation: textGlow 3s infinite alternate;
      opacity: 0.9;
      width: 100%;
      white-space: nowrap;
    }

    @keyframes textGlow {
      from {
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.3), 0 0 10px rgba(255, 255, 255, 0.2);
      }

      to {
        text-shadow: 0 0 15px rgba(255, 255, 255, 0.6), 0 0 25px rgba(0, 255, 255, 0.4);
      }
    }

    /* Day Theme: Lush green, blue sky, futuristic bubbles */
    .bg-day {
      background-image: url('./daybg.png');
      /* Fallback to nature if specific Frutiger art isn't available via URL */
    }

    /* Night Theme: Glowing city, aurora, purple/blue */
    .bg-night {
      background-image: url('./nightbg.png');
    }

    /* Overlay for that "Dreamy" 2000s look */
    .dream-overlay {
      background: radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.1) 100%);
      mix-blend-mode: overlay;
      pointer-events: none;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.2);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Updated Progress Overlay */
    #progress-overlay {
      background: linear-gradient(135deg,
          rgba(0, 0, 0, 0.2) 0%,
          rgba(0, 0, 0, 0.1) 100%);
      backdrop-filter: blur(30px) saturate(160%);
      -webkit-backdrop-filter: blur(30px) saturate(160%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      z-index: 50;
    }

    #progress-overlay h3,
    #progress-overlay p {
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .progress-bar-container {
      width: 100%;
      max-width: 300px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      height: 8px;
      overflow: hidden;
      margin-top: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    #progress-bar {
      background: #169778;
      box-shadow: 0 0 15px rgba(22, 151, 120, 0.6);
    }
  </style>
</head>

<body class="h-screen w-screen relative">

  <!-- Dynamic Background Layer -->
  <div id="bg-layer" class="absolute inset-0 bg-cover bg-center bg-no-repeat z-0 bg-day"></div>
  <div class="dream-overlay absolute inset-0 z-0"></div>

  <!-- Main Flex Layout Container -->
  <main id="main-layout">

    <!-- Left Side Widgets Area -->
    <div class="widgets-main-container">
      <!-- Column 1: Clocks and Notes -->
      <div class="column-1">
        <!-- Analog Clock -->
        <div class="analog-clock" id="analog-clock">
          <!-- Numbers injected by JS -->

          <div class="clock-center"></div>
          <div class="hand hour-hand" id="hour-hand"></div>
          <div class="hand min-hand" id="min-hand"></div>
          <div class="hand sec-hand" id="sec-hand"></div>
        </div>

        <!-- Digital Clock (Middle) -->
        <div class="digital-clock" id="digital-clock">00:00:00</div>

        <!-- Note Space (Bottom of Column 1) -->
        <textarea class="note-space" placeholder="Take a note..."></textarea>
      </div>

      <!-- Column 2: Calendars -->
      <div class="column-2">
        <!-- Monthly Calendar (Top) -->
        <div class="calendar-widget" id="calendar-widget">
          <div class="calendar-grid" id="calendar-grid">
            <!-- Days will be injected by JS -->
          </div>
        </div>

        <!-- Big Date Display (Bottom) -->
        <div class="big-date-container">
          <div class="date-month" id="big-date-month">January</div>
          <div class="date-number" id="big-date-number">01</div>
          <div class="date-day" id="big-date-day">Friday</div>
        </div>
      </div>

      <!-- Footer Area: Stretching Quote -->
      <div class="footer-area">
        <div class="glowing-quote">
          "Where to start? Where to break and let go? Where to change? Where to look and to grow?"
        </div>
      </div>
    </div>

    <!-- Floating Glass Panel (Right Side) -->
    <div
      class="w-96 h-full aero-glass rounded-2xl flex flex-col z-10 overflow-hidden shadow-2xl flex-shrink-0 relative">

      <!-- Header -->
      <div class="p-4 border-b border-white/10 bg-black/10">
        <div class="flex items-center gap-3">
          <div>
            <h1 class="font-bold text-white text-lg drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]">Hopeful Chat</h1>
            <div id="status-badge" class="text-xs text-blue-200 font-semibold flex items-center gap-1 opacity-80">
              <span class="w-2 h-2 rounded-full bg-yellow-400 shadow-sm animate-pulse"></span>
              Initializing WebGPU...
            </div>
          </div>
        </div>
      </div>

      <!-- Chat History -->
      <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="flex gap-2 pop-in">
          <div class="bubble-bot p-3 rounded-xl rounded-tl-none text-sm leading-relaxed max-w-[90%]">
            <p>How was your day?</p>
          </div>
        </div>
      </div>

      <!-- Input Area -->
      <div class="p-4 bg-black/10 border-t border-white/10">
        <form id="chat-form" class="relative">
          <input type="text" id="user-input"
            class="glass-input w-full pl-4 pr-12 py-3 rounded-xl text-sm placeholder-gray-400 transition-all font-medium"
            placeholder="Type a message..." disabled autocomplete="off">
          <button type="submit" id="send-btn"
            class="absolute right-1 top-1 aero-btn w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold disabled:opacity-50 disabled:cursor-not-allowed"
            disabled>
            <i class="fa-solid fa-paper-plane text-sm"></i>
          </button>
        </form>
        <div class="text-center mt-2">
          <p id="time-display" class="text-[10px] text-white/70 font-medium tracking-wider">
            --:--
          </p>
        </div>
      </div>

      <!-- Download Progress Overlay (Aero Glass Style) -->
      <div id="progress-overlay"
        class="absolute inset-0 rounded-2xl hidden flex-col items-center justify-center text-center p-8">
        <div class="w-16 h-16 border-4 border-white/20 rounded-full animate-spin mb-6"
          style="border-top-color: #169778;">
        </div>
        <h3 class="text-xl font-bold mb-2">Downloading Model (One Time Only)</h3>
        <p id="progress-text" class="text-sm opacity-80 mb-6">Preparing components...</p>
        <div class="progress-bar-container">
          <div id="progress-bar" class="h-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <p class="text-[10px] opacity-50 mt-4 tracking-widest uppercase">Loading Model on Your Computer</p>
      </div>

    </div>
  </main>

  <!-- Script Logic -->
  <script type="module">
    import { pipeline, env, TextStreamer } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@latest';

    // --- Configuration ---
    const MODEL_ID = 'onnx-community/SmolLM2-360M-Instruct-ONNX';


    env.allowLocalModels = false;
    env.allowRemoteModels = true;
    env.useBrowserCache = true;

    // --- Elements ---
    const bgLayer = document.getElementById('bg-layer');
    const timeDisplay = document.getElementById('time-display');
    const chatContainer = document.getElementById('chat-container');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const statusBadge = document.getElementById('status-badge');
    const progressOverlay = document.getElementById('progress-overlay');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    let generator = null;
    let messageHistory = [];

    const SYSTEM_INSTRUCTIONS = `Provide one short motivational quote for the user's situation. No other text.

Input: I am tired of trying.
Output: "It always seems impossible until it's done."

Input: I made a mistake at work.
Output: "Mistakes are the portals of discovery."

Input: I feel like I wasted my day.
Output: "Do not let yesterday use up too much of today."

Output Format: Only the quote, no other text.`;

    // --- 1. Aesthetic Logic (Day/Night & Widgets) ---
    function setupAnalogClock() {
      const clock = document.getElementById('analog-clock');
      if (!clock) return;
      const size = clock.offsetWidth;
      const center = size / 2;
      const radius = center - 30; // Better spacing for numbers
      for (let i = 1; i <= 12; i++) {
        const el = document.createElement('div');
        el.className = 'clock-number';
        el.textContent = i;
        const angle = (i * 30) * (Math.PI / 180);
        const x = center + radius * Math.sin(angle) - 15; // 15 is half of 30px width
        const y = center - radius * Math.cos(angle) - 15; // 15 is half of 30px height
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        clock.appendChild(el);
      }
    }

    function updateWidgets() {
      const now = new Date();

      // 1. Digital Clock
      const digitalClock = document.getElementById('digital-clock');
      digitalClock.textContent = now.toLocaleTimeString([], { hour12: false });

      // 2. Analog Clock
      const sec = now.getSeconds();
      const min = now.getMinutes();
      const hour = now.getHours();

      const secDegree = (sec / 60) * 360;
      const minDegree = (min / 60) * 360 + (sec / 60) * 6;
      const hourDegree = (hour / 12) * 360 + (min / 60) * 30;

      document.getElementById('sec-hand').style.transform = `translateX(-50%) rotate(${secDegree}deg)`;
      document.getElementById('min-hand').style.transform = `translateX(-50%) rotate(${minDegree}deg)`;
      document.getElementById('hour-hand').style.transform = `translateX(-50%) rotate(${hourDegree}deg)`;

      // 3. Big Date Display
      document.getElementById('big-date-month').textContent = now.toLocaleString('default', { month: 'long' });
      document.getElementById('big-date-number').textContent = now.getDate().toString().padStart(2, '0');
      document.getElementById('big-date-day').textContent = now.toLocaleString('default', { weekday: 'long' });
    }

    function updateCalendar() {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const today = now.getDate();

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';

      // Day headers
      ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
        const el = document.createElement('div');
        el.className = 'calendar-day-header';
        el.textContent = day;
        grid.appendChild(el);
      });

      // Padding for first day
      for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
      }

      // Days
      for (let i = 1; i <= daysInMonth; i++) {
        const el = document.createElement('div');
        el.className = `calendar-day ${i === today ? 'today' : ''}`;
        el.textContent = i;
        grid.appendChild(el);
      }
    }

    function updateAesthetics() {
      const now = new Date();
      const hour = now.getHours();

      // Format Time (Small display in chat)
      timeDisplay.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      // Determine Cycle (6 AM to 6 PM is Day)
      if (hour >= 6 && hour < 18) {
        bgLayer.classList.remove('bg-night');
        bgLayer.classList.add('bg-day');
      } else {
        bgLayer.classList.remove('bg-day');
        bgLayer.classList.add('bg-night');
      }

      updateWidgets();
      updateCalendar();
    }

    // Update immediately and then every second for clock
    setTimeout(setupAnalogClock, 100); // Wait for layout
    updateAesthetics();
    setInterval(updateWidgets, 1000); // Analog/Digital Clock every second
    setInterval(updateAesthetics, 60000); // Aesthetics every minute

    // --- 2. AI Logic (Gemma 3) ---
    async function init() {
      try {
        if (!navigator.gpu) throw new Error("WebGPU not supported. Use Chrome.");

        progressOverlay.classList.remove('hidden');
        progressOverlay.classList.add('flex');

        generator = await pipeline('text-generation', MODEL_ID, {
          device: 'webgpu',
          dtype: 'q4',
          progress_callback: (data) => {
            if (data.status === 'progress') {
              const percent = Math.round(data.progress || 0);
              progressBar.style.width = `${percent}%`;
              progressText.textContent = `${data.file} (${percent}%)`;
            } else if (data.status === 'done') {
              progressText.textContent = "Compiling Shaders...";
            }
          }
        });

        progressOverlay.classList.add('hidden');
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400 shadow-sm"></span> Ready';

        userInput.disabled = false;
        sendBtn.disabled = false;
        userInput.focus();

      } catch (err) {
        console.error(err);
        progressOverlay.classList.add('hidden');
        statusBadge.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 shadow-sm"></span> Error';
        appendMessage('system', `Error: ${err.message}`);
      }
    }

    // --- 3. Chat Logic ---
    document.getElementById('chat-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = userInput.value.trim();
      if (!text || !generator) return;

      appendMessage('user', text);
      userInput.value = '';
      userInput.disabled = true;
      sendBtn.disabled = true;

      messageHistory.push({ role: "user", content: text });

      // Prepare the full conversation history including system instructions
      const messages = [
        { role: "system", content: SYSTEM_INSTRUCTIONS },
        ...messageHistory
      ];

      // Bot Placeholder
      const botDiv = appendMessage('assistant', '<i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i> Thinking...');
      const botTextEl = botDiv.querySelector('.content-text');

      try {
        // Clear thinking indicator for streaming
        botTextEl.textContent = '';

        const streamer = new TextStreamer(generator.tokenizer, {
          skip_prompt: true,
          skip_special_tokens: true,
          callback_function: (text) => {
            botTextEl.textContent += text;
            chatContainer.scrollTop = chatContainer.scrollHeight;
          },
        });

        const output = await generator(messages, {
          max_new_tokens: 64,          // Keep this small for tiny models to prevent wandering
          temperature: 0.5,           // Lower temperature makes output more stable/focused
          do_sample: true,
          top_p: 0.9,                 // Nucleus sampling helps filter out low-probability junk
          repetition_penalty: 1.2,    // 1.2 is a strong penalty to break loops
          no_repeat_ngram_size: 3,    // Forbids any 3-word sequence from repeating
          streamer
        });

        const rawResult = output[0].generated_text;
        const response = rawResult[rawResult.length - 1].content;

        // Sync final content
        botTextEl.textContent = response;
        messageHistory.push({ role: "assistant", content: response });

      } catch (err) {
        console.error(err);
        botTextEl.textContent = "Error generating response.";
      }

      userInput.disabled = false;
      sendBtn.disabled = false;
      userInput.focus();
    });

    function appendMessage(role, text) {
      const div = document.createElement('div');
      div.className = `flex gap-2 pop-in ${role === 'user' ? 'flex-row-reverse' : ''}`;

      const bubble = document.createElement('div');
      bubble.className = role === 'user'
        ? 'bubble-user p-3 rounded-xl rounded-tr-none text-sm max-w-[90%]'
        : 'bubble-bot p-3 rounded-xl rounded-tl-none text-sm max-w-[90%]';

      // Allow HTML for spinner, otherwise text
      const contentSpan = document.createElement('span');
      contentSpan.className = 'content-text';

      if (text.includes('<i')) bubble.innerHTML = `<span class="content-text">${text}</span>`;
      else {
        contentSpan.textContent = text;
        bubble.appendChild(contentSpan);
      }

      div.appendChild(bubble);
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
      return div;
    }

    init();
  </script>
</body>

</html>